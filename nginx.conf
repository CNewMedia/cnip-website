# Nginx configuration for CNIP.be on Fly.io

# 1. Canoniek domein: www → non-www
server {
    listen 8080;
    server_name www.cnip.be;

    return 301 https://cnip.be$request_uri;
}

# 2. Hoofdsite
server {
    listen 8080;
    server_name cnip.be;

    root /usr/share/nginx/html;
    index index.html;

    # Fly.io proxy fixes - geen :8080 in redirects
    absolute_redirect off;
    port_in_redirect off;

    # -------------------------
    # Security headers
    # -------------------------
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # -------------------------
    # Gzip compressie
    # -------------------------
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/x-javascript
        application/json
        application/xml+rss
        image/svg+xml;

    # -------------------------
    # Trailing slash weg (canoniek zonder /)
    # /cases/ → /cases
    # /cases/hof-van-cleve/ → /cases/hof-van-cleve
    # -------------------------
    rewrite ^(/.+)/$ $1 permanent;

    # -------------------------
    # Static caching
    # -------------------------
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ~* \.(css|js)$ {
        expires 1M;
        add_header Cache-Control "public";
    }

    location ~* \.(woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ~* \.(mp4|webm)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # -------------------------
    # Main location - .html files
    # /cases           → cases.html
    # /cases.html      → cases.html
    # /cases/hof-van-cleve     → cases/hof-van-cleve.html
    # /cases/hof-van-cleve.html → cases/hof-van-cleve.html
    # -------------------------
    location / {
        try_files $uri $uri.html =404;
    }

    # Verborgen files blokkeren (.git, .env, ...)
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
